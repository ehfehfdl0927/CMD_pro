<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD MAPPER 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.CMD.CMD_pro.survey.mapper.SurveyMapper">
    <parameterMap id="surveyVO" type="com.CMD.CMD_pro.survey.domain.SurveyVO"/>
    <parameterMap id="searchCriteria" type="com.CMD.CMD_pro.survey.domain.SearchCriteria"/>
    <parameterMap id="resultDataSet" type="com.CMD.CMD_pro.survey.domain.ResultDataSet"/>

    <resultMap id="surveyVO" type="com.CMD.CMD_pro.survey.domain.SurveyVO"/>
    <resultMap id="surveyItemVo" type="com.CMD.CMD_pro.survey.domain.SurveyItemVO"/>
    <resultMap id="pageMaker" type="com.CMD.CMD_pro.survey.domain.PageMaker"/>
    <resultMap id="resultDataSet" type="com.CMD.CMD_pro.survey.domain.ResultDataSet"/>

    <!-- 검색기능을 위한 동적SQL -->
    <sql id="search">
        <choose>
            <when test="progressing == null or progressing.isEmpty()">
                AND progressing = 1
            </when>
            <otherwise>
                AND progressing = #{progressing}
            </otherwise>
        </choose>
        <if test="searchType != null and !searchType.isEmpty()">
            <bind name="pattern" value="'%' +  searchType  + '%'" />
            <!-- SearchCriteria.keyword로 넘어옴 -->
            <choose>
                <when test="type eq 'writer'">
                    AND name LIKE #{pattern}
                </when>
                <when test="type eq 'title'">
                    AND surveyTitle LIKE #{pattern} OR surveyContent LIKE #{pattern}
                </when>
            </choose>
        </if>
    </sql>

<!--    &lt;!&ndash; 검색기능을 위한 동적SQL &ndash;&gt;-->
<!--    <sql id="search2">-->
<!--        <if test="searchType != null">-->
<!--            <if test="searchType == 't'.toString()">AND survey.surveyTitle LIKE CONCAT('%',#{keyword},'%')</if>-->
<!--            <if test="searchType == 'c'.toString()">AND survey.surveyContent LIKE CONCAT('%',#{keyword},'%')</if>-->
<!--            <if test="searchType == 'w'.toString()">AND users.user_name LIKE CONCAT('%',#{keyword},'%')</if>-->
<!--            <if test="searchType == 'tc'.toString()">AND (survey.surveyTitle LIKE CONCAT('%',#{keyword},'%')) or (survey.surveyContent LIKE CONCAT('%',#{keyword},'%'))</if>-->
<!--        </if>-->
<!--    </sql>-->

    <insert id="insertSurvey">
        insert into survey (surveyIndex, userIndex, surveyTitle, surveyContent, surveyEnd)
        values (surveyIndex.nextval, #{userIndex}, #{surveyTitle}, #{surveyContent},
                #{surveyEnd})
    </insert>

    <insert id="insertSurveyItem">
        insert into surveyItem
        values
            (surveyItemIndex.nextval, surveyIndex.currval, #{surveyItemContent})
    </insert>

    <insert id="addSurveyResult">
        INSERT INTO surveyResult (surveyResultIndex, surveyIndex, surveyItemIndex, userIndex)
        VALUES (surveyResultIndex.nextval, #{surveyIndex}, #{surveyItemIndex}, #{userIndex})
    </insert>

    <select id="selectSurvey" parameterMap="surveyVO" resultMap="SurveyVO">
        SELECT surveyIndex, surveyTitle, users.user_index, surveyReg, surveyContent, progressing, surveyEnd,
               (
                   SELECT COUNT(surveyResultIndex)
                   FROM surveyResult
                            JOIN surveyItem ON surveyResult.surveyItemIndex = surveyItem.surveyItemIndex
                   WHERE surveyItem.surveyIndex = survey.surveyIndex
               ) surveyCount
        FROM survey
                 JOIN users ON survey.userIndex = users.user_index
        WHERE surveyIndex = #{surveyIndex}
    </select>

    <update id="closeSurvey">
        UPDATE survey set PROGRESSING = 0
        WHERE surveyIndex = #{surveyIndex}
    </update>

    <delete id="removeSurvey">
        DELETE FROM survey
        WHERE surveyIndex = #{surveyIndex}
    </delete>

    <!-- 리스트 + 페이징 + 검색 -->
    <select id="selectSurveyList" parameterMap="surveyVO" resultMap="SurveyVO">
        SELECT
        surveyIndex, users.user_index, surveyTitle, surveyContent, surveyReg, surveyEnd, progressing,(
        SELECT COUNT(surveyResultIndex)
        FROM surveyResult
        JOIN surveyItem ON surveyResult.surveyItemIndex = surveyItem.surveyItemIndex
        WHERE surveyItem.surveyIndex = survey.surveyIndex
        )participantCnt
        FROM survey
        JOIN users ON survey.userIndex = users.user_index
        WHERE surveyIndex > 0

        <include refid="search"></include>
        ORDER BY surveyIndex desc
        LIMIT #{pageStart}, #{perPageNum}
    </select>

    <!-- 총 게시물 개수 구하기 -->
    <select id="selectCountPaging" parameterMap="searchCriteria" resultMap="pageMaker" resultType="int">
        <![CDATA[
		SELECT COUNT(surveyIndex)
		FROM survey
		JOIN users ON users.user_index = survey.userIndex
		WHERE surveyIndex > 0
		]]>
        <include refid="search"></include>
    </select>

    <select id="selectResultDataset" parameterMap="resultDataSet" resultMap="resultDataSet">
        SELECT users.user_gender, users.user_name, surveyItem.surveyItemIndex
        FROM surveyItem
        JOIN surveyResult ON surveyResult.surveyItemIndex = surveyItem.surveyItemIndex
        JOIN users ON surveyResult.userIndex = users.userIndex
        WHERE
            surveyItem.surveyIndex = #{surveyIndex}
    </select>


</mapper>